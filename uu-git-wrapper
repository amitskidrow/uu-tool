#!/usr/bin/env bash
# Smart wrapper that auto-updates from git and runs uu

set -euo pipefail

REPO_URL="${UU_REPO_URL:-https://github.com/amitskidrow/uu-tool.git}"
CACHE_DIR="${HOME}/.cache/uu-tool"
UPDATE_INTERVAL=3600  # 1 hour

# Create cache directory
mkdir -p "$CACHE_DIR"

# Check if we need to update
NEED_UPDATE=0
if [[ ! -d "$CACHE_DIR/.git" ]]; then
    NEED_UPDATE=1
elif [[ ! -f "$CACHE_DIR/.last_update" ]] || [[ $(($(date +%s) - $(cat "$CACHE_DIR/.last_update" 2>/dev/null || echo 0))) -gt $UPDATE_INTERVAL ]]; then
    NEED_UPDATE=1
fi

# Update if needed
if [[ $NEED_UPDATE -eq 1 ]]; then
    echo "[uu] Updating from git..." >&2
    if [[ -d "$CACHE_DIR/.git" ]]; then
        cd "$CACHE_DIR" && git pull -q
    else
        git clone -q "$REPO_URL" "$CACHE_DIR"
    fi
    date +%s > "$CACHE_DIR/.last_update"
fi

# Execute the cached version
exec "$CACHE_DIR/uu" "$@"